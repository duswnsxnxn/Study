### 알림 시스템 설계

**문제 이해 및 설계 범위 확정**

- 푸시 알림, SMS 메시지, 이메일 중 어떤 종류의 알림을 지원하는지
- real-time인지 soft-real-time인지
    - soft-real-time은 약간의 지연을 허용한다.
- IOS, 안드로이드, 랩톱/데스크탑 중 어떤 단말을 지원하는지
- 클라이언트 애플리케이션, 서버 스케쥴링 중 어느 것이 알림을 생성할지
- 알림 받지 않기 같은 설정 지원할지
- 하루에 몇 건의 알림을 보낼지

**알림 유형별 지원 방안**

IOS 푸시 알림

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/ef898b03-c479-4aee-83c7-2cb45b93fae4/Untitled.png)

1. 알림 제공자 : 알림 요청을 만들어 애플 푸시 알림 서비스(APNS)로 보내는 주체
요청을 만들려면 단말 토큰과 페이로드 데이터가 필요
    1. 단말 토큰 : 알림 요청을 보내는 데 필요한 고유 식별자
    2. 페이로드 : 알림 내용을 담은 JSON 딕셔너리
    3. 예시
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/d27a5459-baa3-4e5e-b6d2-5a10a323e998/Untitled.png)
    
2. 알림 서비스(APNS) : 애플이 제공하는 원격 서비스이며 IOS 장치로 보내는 역할 담당

안드로이드 푸시 알림

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/f903e1f7-a53b-428a-bb51-ccf6b7c3111d/Untitled.png)

1. IOS와 비슷하지만 APNS이 아니라 FCM을 사용

SMS 메시지

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/4cefdda9-0a3d-45ca-9357-4d0b1f69fb12/Untitled.png)

1. 트윌리오, 넥스모 같은 제 3 사업자의 상용 서비스를 이용함으로 비용이 발생

이메일

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/765d0fae-5485-4ee1-878e-40d86575fa56/Untitled.png)

회사마다 자체 서버 구축하기도 하지만 센드그리드, 메일치프와 같은 상용 이메일 서비스를 주로 이용

![알림 유형별 시스템](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/8e00577d-ef3e-445d-ad7a-047b2935a4ba/Untitled.png)

알림 유형별 시스템

**연락처 정보 수집 절차**

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/d4e3e3bd-de3f-48e4-96ad-e37a0f04cb1c/Untitled.png)

- 알림을 보내려면 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요
- 우리 앱을 설치하거나 처음으로 계정 등록하면 API 서버는 해당 사용자의 정보를 수집하고 데이터베이스에 저장

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/122c4724-6968-467c-8a17-df02e7bb6391/Untitled.png)

- 이메일과 전화번호는 user테이블에
- 한 사용자는 여러 단말을 가질 수 있고 모든 단말에 알림을 전송해야 하기에 단말 토큰은 device 테이블에

**개략적 설계안**

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/a396fe87-1c81-4d80-b812-032520b263bc/Untitled.png)

1부터 N까지의 서비스

- 크론잡
- 마이크로서비스
- 분산 시스템 컴포넌트

알림 시스템

- 서비스 1~N에 알림 전송을 위한 API 제공해야함
- 1개의 서버에서 구축
- 제3자 서비스에 전달할 알림 페이로드를 만들 수 있어야 함

제 3자 서비스

- 알림을 실제로 전달하는 역할을 함
- 확장성을 고려해 서비스를 통합하거나 제거할 수 있어야 함
- 중국에서는 FCM을 사용할 수 없고 Jpush나 PushY를 사용

**문제점**

1. SPOF : 1개밖에 없는 서버에 장애가 발생하면 서비스 전체의 장애로 이어짐
2. 규모 확장성 : 데이터베이스나 캐시 등 중요 컴포넌트의 규모 확장 불가능
3. 성능 병목 : 트래픽 과부하

**개선**

1. 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리
2. 알림 서버 증설
3. 메시지 큐 이용하여 시스템 컴포넌트 사이의 결합을 끊음

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/63373e05-6890-45cd-972b-a22917163e4d/Untitled.png)

- 1~N개의 서비스 : 알림 시스템 서버의 API를 통해 알림을 보낼 서비스
- 알림 서버
    - 알림 전송 API : 스팸 방지를 위해 사내 서비스나 인증된 클라이언트만 이용 가능
    - 알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적 검증 수행
    - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터(알림 템플릿 등등)를 가져오는 기능
    - 알림 전송 : 알림 데이터를 메시지 큐에 넣어서 병렬 처리 가능
    - 알림의 종류별로 별도의 메세지 큐를 구성하여 제3자 서비스 장애 대응
- API 호출 시 전송할 데이터의 예시
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/774fb197-493f-44fc-825f-76a5de10e522/Untitled.png)
    

과정

1. API 호출하여 알림 서버로 알림을 보냄
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져옴
3. 알림을 알림 유형에 따른 메세지 큐에 넣는다.
4. 작업 서버는 메세지 큐에서 알림 이벤트를 꺼내고 제3자 서비스로 보냄
5. 제3자 서비스는 사용자 단말로 알림 전송

**상세 설계**

안정성

- 데이터 손실 방지
    - 알림이 지연되거나 순서가 틀리는 것 정도는 허용해도 데이터 자체가 사라지는건 안됨
    - 알림 데이터를 데이터베이스에 보관하고 재시도 매커니즘 구현
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/a068a0e7-98f5-463a-bbf8-7639aba794b5/Untitled.png)
    
- 알림 중복 전송 방지
    - 알림이 도착하면 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다.
    - 중복된 이벤트라면 버림
    - 중복 전송을 100% 방지하는건 불가능(Why?)

**추가로 필요한 컴포넌트 및 고려사항**

알림 템플릿

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/9aceb7ec-3f26-467d-9790-3f10abacbfeb/Untitled.png)

- 인자나 스타일, 추적 링크만 조정하여 다시 만들지 않아도 됨
- 일관성 유지

알림 설정

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/74e5888e-bf71-4c9d-b05e-c8feeec9252e/Untitled.png)

- 사용자에게 설정을 제공하기 위해 설정 테이블을 따로 만듬
- 알림을 보내기 전에 설정 테이블을 거치도록 함

전송률 제한

- 사용자에게 너무 많은 알림을 보내지 않도록 함

재시도 방법

- 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다.
- 같은 문제가 계속해서 발생하면 개발자에게 통지

푸시 알림과 보안

- appKey와 appSecret을 사용해 인증되거나 승인된 클라이언트만 알림을 보낼 수 있게 함

큐 모니터링

- 알림의 개수를 모니터링하여 작업 서버를 증설할지 말지 결정

이벤트 추적

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/d6a688bb-f928-4cb9-8334-2fc7f7b959d9/Untitled.png)

- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 등등의 메트릭은 사용자를 이해하는데 중요한 요소임
- 데이터 분석 서비스와 통합할 필요가 있다.

**수정된 설계안**

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3a743652-a39a-4855-81df-e10c9c53f7c7/323403db-86ea-4bd9-b179-f72f72ebc34b/Untitled.png)
